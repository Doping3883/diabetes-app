<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hỗ trợ Quản lý ĐTĐ Típ 2</title>
    
    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <!-- Custom Stylesheet -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
        .result-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); margin-top: 1.5rem; border-left: 5px solid #10b981; }
        .result-card-warning { border-left-color: #f59e0b; }
        .result-card-danger { border-left-color: #ef4444; }
        .form-section { background-color: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
        .btn-primary { background-color: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.3s; }
        .btn-danger:hover { background-color: #dc2626; }
        input[type="number"], input[type="date"], input[type="text"], select { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; width: 100%; }
        input[readonly] { background-color: #e5e7eb; cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 0.5rem; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        #patient-manager { background-color: #eef2ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">AI HỖ TRỢ QUẢN LÝ ĐÁI THÁO ĐƯỜNG TÍP 2</h1>
            <p class="text-gray-600 mt-2">(Dựa trên Quyết định 5481/QĐ-BYT & ADA 2025)</p>
        </header>

        <!-- Patient Manager -->
        <div id="patient-manager" class="space-y-4">
            <div>
                <label for="patient-selector" class="block text-sm font-medium text-gray-700">Bệnh nhân hiện tại</label>
                <select id="patient-selector" class="mt-1"></select>
            </div>
            <div class="flex space-x-2">
                 <button id="btn-add-patient" class="btn-primary w-full">Thêm</button>
                 <button id="btn-edit-patient" class="btn-secondary w-full">Sửa</button>
                 <button id="btn-delete-patient" class="btn-danger w-full">Xoá</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap space-x-4" aria-label="Tabs">
                <button id="tab-chandoan" class="py-4 px-1 border-b-2 font-medium text-sm tab-active">1. Chẩn đoán & Sàng lọc</button>
                <button id="tab-tienluong" class="py-4 px-1 border-b-2 font-medium text-sm tab-inactive">2. Tiên lượng & Rủi ro</button>
                <button id="tab-dieutri" class="py-4 px-1 border-b-2 font-medium text-sm tab-inactive">3. Quản lý Điều trị</button>
                <button id="tab-theodoi" class="py-4 px-1 border-b-2 font-medium text-sm tab-inactive">4. Theo dõi & Xuất Báo cáo</button>
            </nav>
        </div>

        <!-- Content Sections -->
        <main>
            <!-- Diagnosis & Screening Section -->
            <div id="content-chandoan">
                <div class="form-section space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Thông tin Bệnh nhân</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="age" class="block text-sm font-medium text-gray-700">Tuổi (tự động tính)</label><input type="number" id="age" class="mt-1 data-field" readonly></div>
                            <div><label for="bmi" class="block text-sm font-medium text-gray-700">Chỉ số khối cơ thể (BMI)</label><input type="number" id="bmi" class="mt-1 data-field"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Các yếu tố nguy cơ</h3>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4" id="risk-factors-container">
                            <div class="flex items-start"><input id="risk-family" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="risk-family" class="ml-3 text-sm text-gray-600">Tiền sử gia đình bị ĐTĐ</label></div>
                            <div class="flex items-start"><input id="risk-cvd" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="risk-cvd" class="ml-3 text-sm text-gray-600">Tiền sử bệnh tim mạch do xơ vữa</label></div>
                            <div class="flex items-start"><input id="risk-hbp" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="risk-hbp" class="ml-3 text-sm text-gray-600">Tăng huyết áp</label></div>
                            <div class="flex items-start"><input id="risk-lipid" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="risk-lipid" class="ml-3 text-sm text-gray-600">Rối loạn lipid máu</label></div>
                            <div class="flex items-start"><input id="risk-pcos" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="risk-pcos" class="ml-3 text-sm text-gray-600">Hội chứng buồng trứng đa nang (PCOS)</label></div>
                            <div class="flex items-start"><input id="risk-inactive" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="risk-inactive" class="ml-3 text-sm text-gray-600">Ít hoạt động thể lực</label></div>
                            <div class="flex items-start"><input id="risk-gdm" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="risk-gdm" class="ml-3 text-sm text-gray-600">Tiền sử ĐTĐ thai kỳ</label></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Kết quả Xét nghiệm</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="fpg" class="block text-sm font-medium text-gray-700">FPG (mg/dL)</label><input type="number" id="fpg" class="mt-1 data-field"></div>
                            <div><label for="ogtt" class="block text-sm font-medium text-gray-700">OGTT 2h (mg/dL)</label><input type="number" id="ogtt" class="mt-1 data-field"></div>
                            <div><label for="hba1c" class="block text-sm font-medium text-gray-700">HbA1c (%)</label><input type="number" id="hba1c" step="0.1" class="mt-1 data-field"></div>
                            <div><label for="random-glucose" class="block text-sm font-medium text-gray-700">Glucose bất kỳ (mg/dL)</label><input type="number" id="random-glucose" class="mt-1 data-field"></div>
                        </div>
                        <div class="mt-4 flex items-start"><input id="symptoms" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="symptoms" class="ml-3 text-sm text-gray-600">Có triệu chứng kinh điển của tăng glucose huyết</label></div>
                    </div>
                    <div class="text-center"><button id="btn-chandoan" class="btn-primary">Phân tích Chẩn đoán</button></div>
                </div>
                <div id="result-chandoan" class="mt-6"></div>
            </div>

            <!-- Prognosis & Risk Section -->
            <div id="content-tienluong" class="hidden">
                <div class="form-section space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Thông tin Lâm sàng & Bệnh sử</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="diabetes-duration" class="block text-sm font-medium text-gray-700">Thời gian mắc ĐTĐ (năm)</label><input type="number" id="diabetes-duration" class="mt-1 data-field"></div>
                            <div><label for="egfr" class="block text-sm font-medium text-gray-700">eGFR (mL/phút/1.73m²)</label><input type="number" id="egfr" class="mt-1 data-field"></div>
                            <div><label for="uacr" class="block text-sm font-medium text-gray-700">UACR (mg/g)</label><input type="number" id="uacr" class="mt-1 data-field"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Bệnh tim mạch & Suy tim</h3>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-start"><input id="has-ascvd" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="has-ascvd" class="ml-3 text-sm text-gray-600">Đã có tiền sử BTMDXV</label></div>
                            <div class="flex items-start"><input id="has-hf" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="has-hf" class="ml-3 text-sm text-gray-600">Đã có suy tim</label></div>
                            <div class="flex items-start"><input id="high-risk-ascvd" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="high-risk-ascvd" class="ml-3 text-sm text-gray-600">Nguy cơ cao BTMDXV</label></div>
                        </div>
                    </div>
                    <div class="text-center"><button id="btn-tienluong" class="btn-primary">Phân tích Tiên lượng</button></div>
                </div>
                <div id="result-tienluong" class="mt-6"></div>
            </div>
            
            <!-- Treatment Management Section -->
            <div id="content-dieutri" class="hidden">
                <div class="form-section space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Tình trạng Hiện tại & Mục tiêu</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="current-hba1c" class="block text-sm font-medium text-gray-700">HbA1c hiện tại (%)</label><input type="number" id="current-hba1c" step="0.1" class="mt-1 data-field"></div>
                            <div><label for="target-hba1c" class="block text-sm font-medium text-gray-700">HbA1c mục tiêu (%)</label><input type="number" id="target-hba1c" step="0.1" class="mt-1 data-field" value="7.0"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Các ưu tiên trong điều trị</h3>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-start"><input id="priority-hypo" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="priority-hypo" class="ml-3 text-sm text-gray-600">Cần giảm thiểu nguy cơ hạ đường huyết</label></div>
                            <div class="flex items-start"><input id="priority-weight" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="priority-weight" class="ml-3 text-sm text-gray-600">Cần giảm cân hoặc hạn chế tăng cân</label></div>
                            <div class="flex items-start"><input id="priority-cost" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded data-field"><label for="priority-cost" class="ml-3 text-sm text-gray-600">Chi phí là vấn đề chính</label></div>
                        </div>
                    </div>
                    <div class="text-center"><button id="btn-dieutri" class="btn-primary">Đề xuất Phác đồ Điều trị</button></div>
                </div>
                <div id="result-dieutri" class="mt-6"></div>
            </div>

            <!-- Tracking & Sharing Section -->
            <div id="content-theodoi" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Data Entry -->
                    <div class="form-section space-y-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Nhập chỉ số hàng ngày</h2>
                        <div><label for="track-date" class="block text-sm font-medium text-gray-700">Ngày</label><input type="date" id="track-date" class="mt-1"></div>
                        <div><label for="track-glucose" class="block text-sm font-medium text-gray-700">Đường huyết lúc đói (mg/dL)</label><input type="number" id="track-glucose" class="mt-1"></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Huyết áp (mmHg)</label>
                            <div class="flex items-center space-x-2 mt-1"><input type="number" id="track-sbp" placeholder="Tâm thu" class="w-1/2"><span class="text-gray-500">/</span><input type="number" id="track-dbp" placeholder="Tâm trương" class="w-1/2"></div>
                        </div>
                        <div><label for="track-weight" class="block text-sm font-medium text-gray-700">Cân nặng (kg)</label><input type="number" id="track-weight" step="0.1" class="mt-1"></div>
                        <div class="text-center"><button id="btn-add-track" class="btn-primary">Thêm Dữ liệu</button></div>
                    </div>
                    <!-- Data Display & Actions -->
                    <div class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-700">Biểu đồ & Báo cáo</h2>
                        <div class="bg-white p-4 rounded-lg shadow"><canvas id="trackingChart"></canvas></div>
                        <div class="grid grid-cols-2 gap-2">
                             <button id="btn-print" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 w-full">In / Xuất PDF</button>
                             <button id="btn-export-excel" class="bg-green-700 text-white px-4 py-2 rounded-lg shadow hover:bg-green-800 w-full">Xuất Excel</button>
                             <button id="btn-share" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600 w-full">Chia sẻ Text</button>
                             <button id="btn-clear-tracking" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow hover:bg-red-600 w-full">Xóa Lịch sử</button>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Lịch sử Theo dõi</h2>
                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đường huyết</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Huyết áp</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cân nặng</th></tr></thead>
                            <tbody id="tracking-history-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <div id="patientModal" class="modal"><div class="modal-content"><span id="closePatientModal" class="close-button">&times;</span><h2 id="patient-modal-title" class="text-xl font-semibold text-gray-700 mb-4"></h2><div class="space-y-4"><label for="patient-name-input" class="block text-sm font-medium">Tên bệnh nhân</label><input type="text" id="patient-name-input" placeholder="Nguyễn Văn A"><label for="patient-dob-input" class="block text-sm font-medium">Ngày sinh</label><input type="date" id="patient-dob-input"><div class="text-right"><button id="btn-save-patient" class="btn-primary">Lưu</button></div></div></div></div>
        <div id="shareModal" class="modal">
            <div class="modal-content">
                <span id="closeShareModal" class="close-button">&times;</span>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Dữ liệu sẵn sàng để chia sẻ</h2>
                <p class="text-sm text-gray-500 mb-4">Sao chép nội dung dưới đây và gửi cho bác sĩ của bạn.</p>
                <textarea id="share-data-content" readonly class="w-full h-64 p-2 border rounded-md bg-gray-50"></textarea>
                <div class="text-center mt-4">
                    <button id="btn-copy-share" class="btn-primary">Sao chép</button>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-xs text-gray-500"><p><strong>Tuyên bố miễn trừ trách nhiệm:</strong> Ứng dụng này chỉ là công cụ hỗ trợ. Các khuyến nghị không thay thế cho chỉ định của bác sĩ.</p></footer>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DB_KEY = 'diabetesAppPWAData';
        let appData = {};
        let trackingChart;
        let isEditMode = false;
        let editingPatientId = null;

        // --- Data Management ---
        const loadData = () => {
            const data = localStorage.getItem(DB_KEY);
            appData = data ? JSON.parse(data) : { patients: [], clinicalData: {}, trackingData: {}, currentPatientId: null };
            if (appData.patients.length === 0) {
                const defaultPatient = { id: Date.now(), name: 'Bệnh nhân Mẫu', dob: '1980-01-01' };
                appData.patients.push(defaultPatient);
                appData.currentPatientId = defaultPatient.id;
                saveData();
            }
        };

        const saveData = () => {
            localStorage.setItem(DB_KEY, JSON.stringify(appData));
        };
        
        const calculateAge = (dobString) => {
            if (!dobString) return null;
            const birthDate = new Date(dobString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        };

        // --- UI Rendering ---
        const renderPatientSelector = () => {
            const selector = document.getElementById('patient-selector');
            selector.innerHTML = '';
            appData.patients.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (${new Date(p.dob).toLocaleDateString('vi-VN')})`;
                selector.appendChild(option);
            });
            selector.value = appData.currentPatientId;
        };
        
        const loadClinicalDataForCurrentPatient = () => {
            const patientId = appData.currentPatientId;
            const patient = appData.patients.find(p => p.id === patientId);
            const data = appData.clinicalData[patientId] || {};
            
            // Auto-calculate and set age
            const ageInput = document.getElementById('age');
            if (patient && patient.dob) {
                ageInput.value = calculateAge(patient.dob);
            } else {
                ageInput.value = '';
            }

            document.querySelectorAll('.data-field').forEach(field => {
                if (field.id === 'age') return; // Skip age field
                if (field.id in data) {
                    field.type === 'checkbox' ? field.checked = data[field.id] : field.value = data[field.id];
                } else {
                    field.type === 'checkbox' ? field.checked = false : field.value = '';
                }
            });
             if(!document.getElementById('target-hba1c').value) {
                document.getElementById('target-hba1c').value = '7.0';
            }
        };
        
        const renderUIForCurrentPatient = () => {
            loadClinicalDataForCurrentPatient();
            renderTrackingHistory();
            renderTrackingChart();
            document.getElementById('result-chandoan').innerHTML = '';
            document.getElementById('result-tienluong').innerHTML = '';
            document.getElementById('result-dieutri').innerHTML = '';
        };

        // --- Patient CRUD ---
        const patientModal = document.getElementById('patientModal');
        const patientModalTitle = document.getElementById('patient-modal-title');
        const patientNameInput = document.getElementById('patient-name-input');
        const patientDobInput = document.getElementById('patient-dob-input');

        document.getElementById('btn-add-patient').addEventListener('click', () => {
            isEditMode = false;
            editingPatientId = null;
            patientModalTitle.textContent = 'Thêm Bệnh nhân Mới';
            patientNameInput.value = '';
            patientDobInput.value = '';
            patientModal.style.display = 'flex';
        });

        document.getElementById('btn-edit-patient').addEventListener('click', () => {
            if(!appData.currentPatientId) {
                alert("Vui lòng chọn một bệnh nhân để sửa.");
                return;
            }
            isEditMode = true;
            editingPatientId = appData.currentPatientId;
            const patient = appData.patients.find(p => p.id === editingPatientId);
            if (!patient) return;
            
            patientModalTitle.textContent = 'Sửa thông tin Bệnh nhân';
            patientNameInput.value = patient.name;
            patientDobInput.value = patient.dob;
            patientModal.style.display = 'flex';
        });

        document.getElementById('btn-save-patient').addEventListener('click', () => {
            const name = patientNameInput.value.trim();
            const dob = patientDobInput.value;
            if (!name || !dob) {
                alert('Vui lòng nhập đầy đủ tên và ngày sinh.');
                return;
            }

            if (isEditMode && editingPatientId) {
                const patientIndex = appData.patients.findIndex(p => p.id === editingPatientId);
                if (patientIndex > -1) {
                    appData.patients[patientIndex].name = name;
                    appData.patients[patientIndex].dob = dob;
                }
            } else {
                const newPatient = { id: Date.now(), name, dob };
                appData.patients.push(newPatient);
                appData.currentPatientId = newPatient.id;
            }
            saveData();
            renderPatientSelector();
            renderUIForCurrentPatient();
            patientModal.style.display = 'none';
        });
        
        document.getElementById('btn-delete-patient').addEventListener('click', () => {
            const patientId = appData.currentPatientId;
            if(!patientId) {
                alert("Không có bệnh nhân nào để xóa.");
                return;
            }
            const patient = appData.patients.find(p => p.id === patientId);
            if (!patient || !confirm(`Bạn có chắc chắn muốn xóa bệnh nhân "${patient.name}" và toàn bộ dữ liệu liên quan không?`)) {
                return;
            }
            
            appData.patients = appData.patients.filter(p => p.id !== patientId);
            delete appData.clinicalData[patientId];
            delete appData.trackingData[patientId];
            
            appData.currentPatientId = appData.patients.length > 0 ? appData.patients[0].id : null;
            
            saveData();
            
            if (appData.patients.length === 0) {
                location.reload(); // Reload to create a new default patient
            } else {
                renderPatientSelector();
                renderUIForCurrentPatient();
            }
        });

        document.getElementById('closePatientModal').addEventListener('click', () => patientModal.style.display = 'none');
        
        // --- Core App Logic & Event Listeners ---
        const switchPatient = (patientId) => {
            appData.currentPatientId = parseInt(patientId);
            renderUIForCurrentPatient();
            saveData();
        };
        
        document.getElementById('patient-selector').addEventListener('change', (e) => switchPatient(e.target.value));
        
        document.querySelectorAll('.data-field').forEach(field => {
            field.addEventListener('change', () => {
                const patientId = appData.currentPatientId;
                if(!patientId) return;
                if(!appData.clinicalData[patientId]) appData.clinicalData[patientId] = {};
                
                if (field.type === 'checkbox') {
                    appData.clinicalData[patientId][field.id] = field.checked;
                } else {
                    appData.clinicalData[patientId][field.id] = field.value;
                }
                saveData();
            });
        });
        
        // --- Analysis Buttons ---
        document.getElementById('btn-chandoan').addEventListener('click', () => {
            const age = parseFloat(document.getElementById('age').value);
            const bmi = parseFloat(document.getElementById('bmi').value);
            const fpg = parseFloat(document.getElementById('fpg').value);
            const ogtt = parseFloat(document.getElementById('ogtt').value);
            const hba1c = parseFloat(document.getElementById('hba1c').value);
            const randomGlucose = parseFloat(document.getElementById('random-glucose').value);
            const hasSymptoms = document.getElementById('symptoms').checked;
            let riskFactorsCount = 0;
            document.querySelectorAll('#risk-factors-container input[type="checkbox"]').forEach(cb => {
                if (cb.checked) riskFactorsCount++;
            });

            const resultDiv = document.getElementById('result-chandoan');
            let resultHTML = '';
            let screeningNeeded = false, screeningReason = '';
            if ((age >= 45) || (bmi >= 23 && riskFactorsCount > 0)) { screeningNeeded = true; screeningReason = 'Theo QĐ 5481/BYT, cần sàng lọc do tuổi ≥ 45 hoặc BMI ≥ 23 và có yếu tố nguy cơ.'; }
            else if (age >= 35) { screeningNeeded = true; screeningReason = 'Theo ADA 2025, cần sàng lọc do tuổi ≥ 35.'; }
            if (screeningNeeded) { resultHTML += `<div class="result-card result-card-warning"><h3 class="text-lg font-semibold text-yellow-700">Khuyến nghị Sàng lọc</h3><p class="mt-2 text-gray-600">Bệnh nhân thuộc nhóm cần được sàng lọc ĐTĐ Típ 2.</p><p class="mt-1 text-sm text-gray-500"><em>Lý do: ${screeningReason}</em></p></div>`; }
            let diagnosis = 'Bình thường', diagnosisDetails = 'Các chỉ số nằm trong giới hạn bình thường.', cardClass = 'result-card';
            const isFpgDiabetes = fpg >= 126, isOgttDiabetes = ogtt >= 200, isHba1cDiabetes = hba1c >= 6.5, isRandomDiabetes = randomGlucose >= 200 && hasSymptoms;
            const isFpgPrediabetes = fpg >= 100 && fpg <= 125, isOgttPrediabetes = ogtt >= 140 && ogtt <= 199, isHba1cPrediabetes = hba1c >= 5.7 && hba1c <= 6.4;
            const diabetesTests = [isFpgDiabetes, isOgttDiabetes, isHba1cDiabetes].filter(Boolean).length;
            if (isRandomDiabetes || (!hasSymptoms && diabetesTests >= 2)) { diagnosis = 'Chẩn đoán Đái tháo đường Típ 2'; diagnosisDetails = 'Bệnh nhân có đủ tiêu chuẩn chẩn đoán ĐTĐ Típ 2.'; cardClass = 'result-card result-card-danger'; }
            else if (isFpgDiabetes || isOgttDiabetes || isHba1cDiabetes) { if (!hasSymptoms) { diagnosis = 'Nghi ngờ Đái tháo đường Típ 2'; diagnosisDetails = 'Có 1 chỉ số bất thường. Cần làm lại xét nghiệm lần 2 để xác định.'; cardClass = 'result-card result-card-danger'; } else { diagnosis = 'Chẩn đoán Đái tháo đường Típ 2'; diagnosisDetails = 'Có triệu chứng kinh điển và 1 chỉ số bất thường, đủ tiêu chuẩn chẩn đoán.'; cardClass = 'result-card result-card-danger'; } }
            else if (isFpgPrediabetes || isOgttPrediabetes || isHba1cPrediabetes) { diagnosis = 'Chẩn đoán Tiền Đái tháo đường'; diagnosisDetails = 'Chỉ số nằm trong ngưỡng Tiền ĐTĐ. Cần tư vấn thay đổi lối sống.'; cardClass = 'result-card result-card-warning'; }
            resultHTML += `<div class="${cardClass}"><h3 class="text-lg font-semibold ${diagnosis.includes('Đái tháo đường') ? 'text-red-700' : (diagnosis.includes('Tiền') ? 'text-yellow-700' : 'text-green-700')}">Kết quả: ${diagnosis}</h3><p class="mt-2 text-gray-600">${diagnosisDetails}</p></div>`;
            resultDiv.innerHTML = resultHTML;
        });

        document.getElementById('btn-tienluong').addEventListener('click', () => {
            const hasAscvd = document.getElementById('has-ascvd').checked;
            const hasHf = document.getElementById('has-hf').checked;
            const isHighRiskAscvd = document.getElementById('high-risk-ascvd').checked;
            const egfr = parseFloat(document.getElementById('egfr').value);
            const uacr = parseFloat(document.getElementById('uacr').value);
            const resultDiv = document.getElementById('result-tienluong');
            let resultHTML = '', riskProfile = [];
            if (hasAscvd) { riskProfile.push({ title: 'BTMDXV đã xác định', details: 'Nguy cơ tim mạch rất cao. Ưu tiên liệu pháp bảo vệ tim mạch.', class: 'result-card-danger' }); }
            else if (isHighRiskAscvd) { riskProfile.push({ title: 'Nguy cơ BTMDXV cao', details: 'Ưu tiên liệu pháp bảo vệ tim mạch.', class: 'result-card-danger' }); }
            if (hasHf) { riskProfile.push({ title: 'Suy tim đã xác định', details: 'Ưu tiên liệu pháp giảm nhập viện do suy tim.', class: 'result-card-danger' }); }
            if (egfr < 60 || uacr >= 30) {
                let ckdDetails = 'Bệnh nhân có dấu hiệu bệnh thận mạn. ';
                if (egfr < 30) ckdDetails += 'Suy thận nặng (eGFR < 30). '; else if (egfr < 60) ckdDetails += 'Suy thận (eGFR 30-60). ';
                if (uacr >= 300) ckdDetails += 'Albumin niệu nặng (UACR > 300).'; else if (uacr >= 30) ckdDetails += 'Albumin niệu vừa (UACR 30-299).';
                riskProfile.push({ title: 'Bệnh thận mạn (CKD)', details: ckdDetails + ' Ưu tiên liệu pháp bảo vệ thận.', class: 'result-card-danger' });
            }
            if (riskProfile.length === 0) { resultHTML = `<div class="result-card"><h3 class="text-lg font-semibold text-green-700">Rủi ro Thấp</h3><p class="mt-2 text-gray-600">Chưa phát hiện yếu tố nguy cơ tim mạch/thận chiếm ưu thế.</p></div>`; }
            else { riskProfile.forEach(risk => { resultHTML += `<div class="result-card ${risk.class}"><h3 class="text-lg font-semibold ${risk.class.includes('danger') ? 'text-red-700' : 'text-yellow-700'}">${risk.title}</h3><p class="mt-2 text-gray-600">${risk.details}</p></div>`; }); }
            resultDiv.innerHTML = resultHTML;
        });

        document.getElementById('btn-dieutri').addEventListener('click', () => {
            const hasAscvd = document.getElementById('has-ascvd').checked;
            const hasHf = document.getElementById('has-hf').checked;
            const isHighRiskAscvd = document.getElementById('high-risk-ascvd').checked;
            const egfr = parseFloat(document.getElementById('egfr').value);
            const uacr = parseFloat(document.getElementById('uacr').value);
            const hasCkd = egfr < 60 || uacr >= 30;
            const priorityHypo = document.getElementById('priority-hypo').checked;
            const priorityWeight = document.getElementById('priority-weight').checked;
            const priorityCost = document.getElementById('priority-cost').checked;
            const resultDiv = document.getElementById('result-dieutri');
            let recommendations = [];
            recommendations.push({ step: 'Liệu pháp đầu tay', details: '<strong>Metformin và thay đổi lối sống toàn diện</strong> là nền tảng điều trị.', class: 'result-card' });
            if (hasAscvd || isHighRiskAscvd || hasHf || hasCkd) {
                let recs = [];
                if (hasAscvd || isHighRiskAscvd) { recs.push('<strong>Ưu tiên BTMDXV:</strong> Lựa chọn <strong>GLP-1 RA</strong> hoặc <strong>SGLT2i</strong> có chứng minh lợi ích tim mạch.'); }
                if (hasHf || hasCkd) { recs.push('<strong>Ưu tiên Suy tim/Bệnh thận mạn:</strong> Lựa chọn <strong>SGLT2i</strong>. Nếu không dung nạp, xem xét <strong>GLP-1 RA</strong>.'); }
                recommendations.push({ step: 'Điều trị trên bệnh nhân nguy cơ cao', details: 'Cần thêm các liệu pháp sau vào phác đồ (độc lập với HbA1c):<ul>' + recs.map(r => `<li class="list-disc ml-5 mt-1">${r}</li>`).join('') + '</ul>', class: 'result-card-danger' });
            } else {
                let recs = [];
                if (priorityWeight) { recs.push('<strong>Ưu tiên giảm cân:</strong> Lựa chọn <strong>GLP-1 RA</strong> (hiệu quả nhất) hoặc <strong>SGLT2i</strong>.'); }
                if (priorityHypo) { recs.push('<strong>Ưu tiên tránh hạ đường huyết:</strong> Lựa chọn <strong>DPP-4i, GLP-1 RA, SGLT2i,</strong> hoặc <strong>TZD</strong>.'); }
                if (priorityCost) { recs.push('<strong>Ưu tiên chi phí:</strong> Cân nhắc <strong>Sulfonylurea (SU)</strong> hoặc <strong>TZD</strong>.'); }
                if (recs.length > 0) {
                   recommendations.push({ step: 'Lựa chọn thuốc phối hợp với Metformin', details: 'Nếu Metformin đơn trị không đạt mục tiêu, lựa chọn thuốc thứ hai dựa trên ưu tiên:<ul>' + recs.map(r => `<li class="list-disc ml-5 mt-1">${r}</li>`).join('') + '</ul>', class: 'result-card-warning' });
                }
            }
            recommendations.push({ step: 'Liệu pháp tiêm (nếu cần)', details: 'Nếu không đạt mục tiêu, cân nhắc liệu pháp tiêm. <strong>Ưu tiên GLP-1 RA hơn Insulin</strong> nếu có thể. Cân nhắc Insulin nếu HbA1c rất cao (>10%) hoặc có triệu chứng dị hóa.', class: 'result-card' });
            resultDiv.innerHTML = recommendations.map(rec => `<div class="${rec.class}"><h3 class="text-lg font-semibold ${rec.class.includes('danger') ? 'text-red-700' : (rec.class.includes('warning') ? 'text-yellow-700' : 'text-blue-700')}">${rec.step}</h3><div class="mt-2 text-gray-600">${rec.details}</div></div>`).join('');
        });

        // --- Tracking Logic ---
        const getTrackingDataForCurrentPatient = () => appData.trackingData[appData.currentPatientId] || [];
        const saveTrackingDataForCurrentPatient = (data) => {
            if (appData.currentPatientId) {
                appData.trackingData[appData.currentPatientId] = data;
                saveData();
            }
        };
        const renderTrackingHistory = () => {
            const data = getTrackingDataForCurrentPatient();
            const tbody = document.getElementById('tracking-history-body');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Chưa có dữ liệu theo dõi.</td></tr>`;
                return;
            }
            data.forEach(item => {
                const row = `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.date).toLocaleDateString('vi-VN')}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.glucose || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.sbp && item.dbp ? `${item.sbp}/${item.dbp}` : 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.weight || 'N/A'}</td></tr>`;
                tbody.innerHTML += row;
            });
        };
        const renderTrackingChart = () => {
            const data = getTrackingDataForCurrentPatient();
            const ctx = document.getElementById('trackingChart').getContext('2d');
            const labels = data.map(item => new Date(item.date).toLocaleDateString('vi-VN'));
            if (trackingChart) trackingChart.destroy();
            trackingChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Đường huyết (mg/dL)', data: data.map(item => item.glucose), borderColor: 'rgb(239, 68, 68)', yAxisID: 'y', }, { label: 'Cân nặng (kg)', data: data.map(item => item.weight), borderColor: 'rgb(59, 130, 246)', yAxisID: 'y1', } ] }, options: { responsive: true, interaction: { mode: 'index', intersect: false, }, scales: { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Đường huyết' } }, y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Cân nặng' }, grid: { drawOnChartArea: false } } } } });
        };
        document.getElementById('btn-add-track').addEventListener('click', () => {
             const date = document.getElementById('track-date').value;
             if (!date) { alert('Vui lòng chọn ngày.'); return; }
             const newData = { date, glucose: parseFloat(document.getElementById('track-glucose').value) || null, sbp: parseFloat(document.getElementById('track-sbp').value) || null, dbp: parseFloat(document.getElementById('track-dbp').value) || null, weight: parseFloat(document.getElementById('track-weight').value) || null };
             let data = getTrackingDataForCurrentPatient();
             data.push(newData);
             data.sort((a, b) => new Date(a.date) - new Date(b.date));
             saveTrackingDataForCurrentPatient(data);
             renderTrackingHistory();
             renderTrackingChart();
             document.getElementById('track-glucose').value = ''; document.getElementById('track-sbp').value = ''; document.getElementById('track-dbp').value = ''; document.getElementById('track-weight').value = '';
        });
        document.getElementById('btn-clear-tracking').addEventListener('click', () => {
            if (confirm('Bạn có chắc muốn xóa toàn bộ lịch sử theo dõi của bệnh nhân này?')) {
                saveTrackingDataForCurrentPatient([]);
                renderTrackingHistory();
                renderTrackingChart();
            }
        });
        
        // --- Export & Print & Share ---
        const shareModal = document.getElementById('shareModal');
        document.getElementById('btn-share').onclick = () => {
            const data = getTrackingDataForCurrentPatient();
            if (data.length === 0) { alert('Không có dữ liệu để chia sẻ.'); return; }
            let textContent = `Lịch sử theo dõi sức khỏe:\n\n`;
            data.forEach(item => {
                textContent += `Ngày: ${new Date(item.date).toLocaleDateString('vi-VN')}\n`;
                if(item.glucose) textContent += `- Đường huyết: ${item.glucose} mg/dL\n`;
                if(item.sbp && item.dbp) textContent += `- Huyết áp: ${item.sbp}/${item.dbp} mmHg\n`;
                if(item.weight) textContent += `- Cân nặng: ${item.weight} kg\n`;
                textContent += '-----------------\n';
            });
            document.getElementById('share-data-content').value = textContent;
            shareModal.style.display = 'flex';
        };
        document.getElementById('closeShareModal').addEventListener('click', () => { shareModal.style.display = 'none'; });
        document.getElementById('btn-copy-share').addEventListener('click', () => {
            const content = document.getElementById('share-data-content');
            content.select();
            document.execCommand('copy');
            const btn = document.getElementById('btn-copy-share');
            btn.innerText = 'Đã sao chép!';
            setTimeout(() => { btn.innerText = 'Sao chép'; }, 2000);
        });

        document.getElementById('btn-print').addEventListener('click', () => {
            const patientId = appData.currentPatientId;
            const patient = appData.patients.find(p => p.id === patientId);
            const clinicalData = appData.clinicalData[patientId] || {};
            const trackingData = getTrackingDataForCurrentPatient();

            if (!patient) return;

            let reportHTML = `
                <html><head><title>Báo cáo Sức khỏe - ${patient.name}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style> body { font-family: "Inter", sans-serif; padding: 2rem; } @media print { body { -webkit-print-color-adjust: exact; } .no-print { display: none; } } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #f2f2f2; } h1, h2 { color: #3b82f6; } </style>
                </head><body>
                <h1 class="text-2xl font-bold mb-4">BÁO CÁO SỨC KHỎE</h1>
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-2">Thông tin Bệnh nhân</h2>
                    <p><strong>Tên:</strong> ${patient.name}</p>
                    <p><strong>Ngày sinh:</strong> ${new Date(patient.dob).toLocaleDateString('vi-VN')}</p>
                    <p><strong>Tuổi:</strong> ${calculateAge(patient.dob)}</p>
                    <p><strong>BMI:</strong> ${clinicalData.bmi || 'N/A'}</p>
                </div>
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-2">Lịch sử Theo dõi</h2>`;
            if (trackingData.length > 0) {
                reportHTML += `<table><thead><tr><th>Ngày</th><th>Đường huyết (mg/dL)</th><th>Huyết áp (mmHg)</th><th>Cân nặng (kg)</th></tr></thead><tbody>`;
                trackingData.forEach(item => {
                    reportHTML += `<tr><td>${new Date(item.date).toLocaleDateString('vi-VN')}</td><td>${item.glucose || ''}</td><td>${item.sbp && item.dbp ? `${item.sbp}/${item.dbp}` : ''}</td><td>${item.weight || ''}</td></tr>`;
                });
                reportHTML += `</tbody></table>`;
            } else {
                reportHTML += `<p>Không có dữ liệu theo dõi.</p>`;
            }
            reportHTML += `</div><p class="text-xs text-gray-500 mt-8">Báo cáo được tạo bởi Ứng dụng AI Hỗ trợ Quản lý ĐTĐ vào ngày ${new Date().toLocaleDateString('vi-VN')}.</p></body></html>`;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            setTimeout(() => { 
                reportWindow.print();
                reportWindow.close();
            }, 500);
        });

        document.getElementById('btn-export-excel').addEventListener('click', () => {
            const patientId = appData.currentPatientId;
            const patient = appData.patients.find(p => p.id === patientId);
            const clinicalData = appData.clinicalData[patientId] || {};
            const trackingData = getTrackingDataForCurrentPatient();
            
            if (!patient) return;
            
            const info = [
                { "Thông tin": "Tên Bệnh nhân", "Giá trị": patient.name },
                { "Thông tin": "Ngày sinh", "Giá trị": new Date(patient.dob).toLocaleDateString('vi-VN') },
                { "Thông tin": "Tuổi", "Giá trị": calculateAge(patient.dob) },
                { "Thông tin": "BMI", "Giá trị": clinicalData.bmi || "" },
                { "Thông tin": "Thời gian mắc ĐTĐ (năm)", "Giá trị": clinicalData['diabetes-duration'] || "" },
                { "Thông tin": "eGFR (mL/phút/1.73m²)", "Giá trị": clinicalData.egfr || "" },
                { "Thông tin": "UACR (mg/g)", "Giá trị": clinicalData.uacr || "" },
                { "Thông tin": "HbA1c Hiện tại (%)", "Giá trị": clinicalData['current-hba1c'] || "" },
            ];
            const infoSheet = XLSX.utils.json_to_sheet(info);

            const trackingExport = trackingData.map(d => ({
                "Ngày": new Date(d.date).toLocaleDateString('vi-VN'),
                "Đường huyết (mg/dL)": d.glucose,
                "Huyết áp Tâm thu (mmHg)": d.sbp,
                "Huyết áp Tâm trương (mmHg)": d.dbp,
                "Cân nặng (kg)": d.weight
            }));
            const trackingSheet = XLSX.utils.json_to_sheet(trackingExport);
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, infoSheet, "Thông tin Bệnh nhân");
            XLSX.utils.book_append_sheet(wb, trackingSheet, "Lịch sử Theo dõi");
            
            XLSX.writeFile(wb, `Bao_cao_${patient.name.replace(/ /g,"_")}.xlsx`);
        });

        // --- Initial Load ---
        const tabs = document.querySelectorAll('nav button');
        const contents = document.querySelectorAll('main > div');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('tab-active');
                    t.classList.add('tab-inactive');
                });
                contents.forEach(c => c.classList.add('hidden'));

                tab.classList.add('tab-active');
                tab.classList.remove('tab-inactive');
                const contentId = 'content-' + tab.id.split('-')[1];
                document.getElementById(contentId).classList.remove('hidden');
            });
        });

        loadData();
        renderPatientSelector();
        renderUIForCurrentPatient();
    });
    </script>
</body>
</html>
